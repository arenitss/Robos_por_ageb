---
title: "EDA. Incidencia Delictiva por AGEB"
author: "A_NAYELLI XXX, R_URIEL ABRAHAM XXX, ZC_JOSE LUIS R. 183347"
date: "06/11/2021"
output: html_document
---

```{r}
knitr::opts_chunk$set(echo = FALSE)


## ID_F0 --> This function aim to install and load libraries required.
rm(list = ls())

instalar <- function(paquete) {
  if (!require(paquete,character.only = TRUE, quietly = TRUE,
               warn.conflicts = FALSE)) {
    install.packages(as.character(paquete), dependecies = TRUE,
                     repos = "http://cran.us.r-project.org")
    library(paquete, character.only = TRUE, quietly = TRUE,
            warn.conflicts = FALSE)
  }
}
    
## *******   Defining required libraries to install and load   *******

## Use this vector to indicate libraries to load.
paquetes <- c("tensorflow", "keras", "tidyverse","stringi",
              "tidymodels", "glmnet", "kknn","gt","ranger")

#paquetes <- c('readr', 'tidyr', 'tibble', 'dplyr', 'magrittr', 'lubridate',
#              'stringr','ggplot2', 'forcats', "gridExtra", 'ggthemes',
#              'GGally','mice','VIM')

lapply(paquetes, instalar)

## Load piping files and review of working libraries

#source("../src/etl/metadata.R"  , encoding = 'UTF-8')
source("../src/utils/utils.R", encoding = 'UTF-8')
#source("../src/etl/00-load.R", encoding = 'UTF-8')
#source("../src/etl/01-prepare.R", encoding = 'UTF-8')
#ource("../src/etl/02-clean.R", encoding = 'UTF-8')
#source("../src/etl/03-eda.R", encoding = 'UTF-8')
#source("../src/etl/ggbiplot.R",   encoding = 'UTF-8')


```


### DATABASE


```{r}

# Importar archivo y codificar

csv_file <- readLines("../data/ageb_censo_delitos_wifi.csv")
csv_utf <- iconv(csv_file,"latin1", "UTF-8") # produces an error

#database <- read_csv(csv_utf, skip_empty_rows = TRUE)
#database

database <- read_csv("../data/ageb_censo_delitos_wifi.csv")

```

## Tidy Process

```{r}
# *******   Preview of Dataset   *******
ageb_censo_delitos_wifi <- database
glimpse(ageb_censo_delitos_wifi)
```


### LIMPIEZA
```{r}


# cleaning column_name

nom_cols <-  colnames (ageb_censo_delitos_wifi)
nom_cols <- str_replace_all(tolower(nom_cols),pattern = "/| |-",replacement = '_')
nom_cols <- str_replace_all(tolower(nom_cols), pattern = ":|::|\\.", replacement = '')
nom_cols <- str_replace_all(tolower(nom_cols), pattern = "#", replacement = 'num')
nom_cols <- stri_enc_toutf8(nom_cols)

colnames(ageb_censo_delitos_wifi) <- nom_cols

# categorical columns
v_cat <- c("nom_mun")
ageb_censo_delitos_wifi <- ageb_censo_delitos_wifi %>% mutate(across(v_cat, ~ as.factor(.x)))


# Remove irrelevant columns: Quitamos la primera columna (índice) y
# la variable NOM_ENT -> Ciudad de Méxi
ageb_censo_delitos_wifi <- ageb_censo_delitos_wifi %>% select(-1, -nom_ent)

# Reemplazamos con 0 los nas de las columnas de delitos, NA -> no hubo delitos en esa ageb
v_cat <- c(52:63)
ageb_censo_delitos_wifi <- ageb_censo_delitos_wifi %>% mutate(across(v_cat, ~ ifelse(is.na(.x)==TRUE,0,.x)))

# Corregimos los caracteres incorrectos en la vairiable nombre del municipio.
ageb_censo_delitos_wifi$nom_mun <- ageb_censo_delitos_wifi$nom_mun %>%
  fct_relabel(~ gsub("µ", "a", .x))
ageb_censo_delitos_wifi$nom_mun <- ageb_censo_delitos_wifi$nom_mun %>%
  fct_relabel(~ gsub("¢", "o", .x))
ageb_censo_delitos_wifi$nom_mun <- ageb_censo_delitos_wifi$nom_mun %>%
  fct_relabel(~ gsub("\u0082", "e", .x))
ageb_censo_delitos_wifi$nom_mun <- ageb_censo_delitos_wifi$nom_mun %>%
  fct_relabel(~ gsub("\\.", "", .x))
ageb_censo_delitos_wifi$nom_mun <- ageb_censo_delitos_wifi$nom_mun %>%
  fct_relabel(~ gsub(" ", "_", .x))
ageb_censo_delitos_wifi$nom_mun <- ageb_censo_delitos_wifi$nom_mun %>%
  fct_relabel( ~ str_replace_all(tolower(.x), pattern =" ", replacement = "a"))


# Creamos la variable de poblacion que entre 15 y 24 años que no asiste a la escuela que faltaba
ageb_censo_delitos_wifi <- ageb_censo_delitos_wifi %>%
  mutate(p15a24a = p15a17a + p18a24a)

ageb_censo_delitos_wifi <- ageb_censo_delitos_wifi %>%
  mutate(p15a24a_f = p15a17a_f + p18a24a_f)

ageb_censo_delitos_wifi <- ageb_censo_delitos_wifi %>%
  mutate(p15a24a_m = p15a17a_m + p18a24a_m)


ageb_censo_delitos_wifi <- ageb_censo_delitos_wifi %>%
  mutate(p_15a24 = p_15a17 + p_18a24)

ageb_censo_delitos_wifi <- ageb_censo_delitos_wifi %>%
  mutate(p_15a24_f = p_15a17_f + p_18a24_f)

ageb_censo_delitos_wifi <- ageb_censo_delitos_wifi %>%
  mutate(p_15a24_m = p_15a17_m + p_18a24_m)


# Eliminamos las variables que ya no son necesarias
ageb_censo_delitos_wifi <- ageb_censo_delitos_wifi %>%
  select(-p_15a17, -p_18a24, -p_15a17_m, -p_18a24_m, -p_15a17_f, -p_18a24_f,
         -p15a17a, -p18a24a, -p15a17a_f, -p18a24a_f, -p15a17a_m, -p18a24a_m)


# Relocate variables:
# --> Pasamos Robo de vehículos al inicio de la base
ageb_censo_delitos_wifi <- ageb_censo_delitos_wifi %>%
  relocate(robo_vehículos)

# --> Pasamos Robo de vehículos al inicio de la base
ageb_censo_delitos_wifi <- ageb_censo_delitos_wifi %>%
  relocate(matches("^p15"), .before = pnacoe) %>%
  relocate(matches("^p_15"), .after = pnacoe) 

glimpse(ageb_censo_delitos_wifi)

#unique(ageb_censo_delitos_wifi$nom_mun)
colnames(ageb_censo_delitos_wifi)

```



Imputamos con la mediana los nas del resto de las columnas

```{r}
#columnas que se desea imputar valores centrales
col_valor_central <- c(10:48,57)
#imputacion por valor central
ageb_censo_delitos_wifi <- imputar_valor_central(data.frame(ageb_censo_delitos_wifi), col_valor_central)

```

```{r}
glimpse(ageb_censo_delitos_wifi)
```

```{r}
summary(ageb_censo_delitos_wifi)
```
Estandarizamos columnas
```{r}

for (i in 9:57){
  ageb_censo_delitos_wifi[,i] <- (ageb_censo_delitos_wifi[,i] - mean(ageb_censo_delitos_wifi[,i])) / sd(ageb_censo_delitos_wifi[,i])
}
```


```{r}
ageb_censo_delitos_wifi$robo_vehículos <- (ageb_censo_delitos_wifi$robo_vehículos - mean(ageb_censo_delitos_wifi$robo_vehículos)) / sd(ageb_censo_delitos_wifi$robo_vehículos)
```


```{r}
summary(ageb_censo_delitos_wifi)
```


### Modelos con dummies y con bandas

https://www.elfinanciero.com.mx/nacional/40-bandas-se-disputan-la-cdmx/
```{r}
unique(ageb_censo_delitos_wifi$nom_mun)
```
LISTADO DE NOMBRE DE DELEGACIONES

"alvaro_obregon", "tlalpan", "benito_ju rez",  "iztacalco",  "azcapotzalco", "venustiano_carranza", "tl huac", "gustavo_a_madero",
"miguel_hidalgo", "xochimilco", "cuajimalpa_de_morelos", "la_magdalena_contreras", "milpa_alta", "cuauhtemoc", "coyoac n", "iztapalapa"


Bandas
```{r}

# union_tepito
ageb_censo_delitos_wifi <- ageb_censo_delitos_wifi %>%
  mutate( union_tepito = ifelse(
    nom_mun %in% c("alvaro_obregon", "azcapotzalco", "benito_ju rez", "coyoac n",
                   "cuauhtemoc", "gustavo_a_madero", "iztacalco", "la_magdalena_contreras",
                   "miguel_hidalgo", "tlalpan", "venustiano_carranza"), 1, 0))

#CJNG
ageb_censo_delitos_wifi <- ageb_censo_delitos_wifi %>%
  mutate( cjng = ifelse(
    nom_mun %in% c("alvaro_obregon", "benito_ju rez",  "cuajimalpa_de_morelos", 
                   "cuauhtemoc", "gustavo_a_madero",  "iztapalapa", "tlalpan"), 1, 0))

#cartel_de_tlahuac
ageb_censo_delitos_wifi <- ageb_censo_delitos_wifi %>%
  mutate( cartel_de_tlahuac  = ifelse(
    nom_mun %in% c("alvaro_obregon", "tl huac", "iztapalapa", "milpa_alta", "tlalpan", "xochimilco"), 1, 0))


#lenin_canchola
ageb_censo_delitos_wifi <- ageb_censo_delitos_wifi %>%
  mutate( lenin_canchola  = ifelse(
    nom_mun %in% c("alvaro_obregon", "benito_ju rez", "la_magdalena_contreras", "miguel_hidalgo", "tlalpan"), 1, 0))


#anti_union_tepito
ageb_censo_delitos_wifi <- ageb_censo_delitos_wifi %>%
  mutate( anti_union_tepito  = ifelse(
    nom_mun %in% c("alvaro_obregon", "azcapotzalco", "cuauhtemoc", "iztacalco",  "venustiano_carranza"), 1, 0))


#rodolfos
ageb_censo_delitos_wifi <- ageb_censo_delitos_wifi %>%
  mutate( rodolfos  = ifelse(
    nom_mun %in% c("alvaro_obregon", "coyoac n", "iztacalco", "milpa_alta", "tl huac", "xochimilco"), 1, 0))


```


## EDA
Análisis bivariado
```{r}
many_scatter_plots <- ManyPlots(df = dplyr::select_if(ageb_censo_delitos_wifi, is.numeric),tipo_grafica = ScatterPlot)
many_scatter_plots

```


```{r}
many_loess_plots <- ManyPlots(df = dplyr::select_if(ageb_censo_delitos_wifi,
                                                    is.numeric),tipo_grafica = LoessPlot)
many_loess_plots
```

## MODELO 1: 


```{r}
set.seed(84351)
robos_split <- initial_split(ageb_censo_delitos_wifi, prop = 0.75)
robos_entrena <- training(robos_split)
robos_prueba <- testing(robos_split)
```


```{r}
robos_receta <- recipe(robo_vehículos ~
                         pop_15_24 + p15ym_an + p15a24a + graproes + pea +
                         pocupada + pdesocup + psinder + phogjef_f + vivpar_des +
                         pro_ocup_c+ vph_pisoti + vph_s_elec + vph_aguafv + vph_nodren +
                         vph_inter + amenzas + fraude + robo_objetos +
                         robo_objetos_vehiculo +
                         robo_transeunte + robo_accesorios_autos +
                         robo_negocio_sin_violencia_autoservicio  +
                         robo_negocio_sin_violencia + narcomenudeo +
                         robo_casa_sin_violencia + postes_wifi,
                       robos_entrena)
```

```{r}
modelo_penalizado <- linear_reg(mixture = tune(), penalty = tune()) %>%
  set_args(lambda.min_ratio = 1e-18) %>%
  set_engine("glmnet")  

flujo_robos <- workflow() %>% 
  add_recipe(robos_receta) %>% 
  add_model(modelo_penalizado)
```

```{r}
val_split <- manual_rset(robos_split %>% list(), "validación")
# hacemos un grid de valores de mezcla y penalización

params <- parameters(penalty(range = c(-5, 2), trans = log10_trans()),
                            mixture(range = c(0, 1)))
grid <- grid_regular(params, levels = c(penalty = 20, mixture = 5))
grid
```

```{r}
mis_metricas <- metric_set(rmse)

eval_tbl <- tune_grid(flujo_robos,
                      resamples = val_split,
                      grid = grid,
                      metrics = mis_metricas) 
```

```{r}
ajustes_tbl <- eval_tbl %>%
  unnest(cols = c(.metrics)) %>% 
  select(id, mixture, penalty, .metric, .estimate)
ajustes_tbl
```


```{r}
ggplot(ajustes_tbl, aes(x = penalty, y = .estimate, colour = mixture, group = mixture)) +
  geom_point() + geom_line() + scale_x_log10()
```

```{r}
mejor_modelo <- select_best(eval_tbl)
mejor_modelo
```

```{r}
modelo_final <- finalize_workflow(flujo_robos, mejor_modelo) %>%
  fit(robos_entrena)
```

```{r}
robos_receta_2 <- recipe(robo_vehículos ~
                           pop_15_24 + p15ym_an + p15a24a + graproes + pea +
                           pocupada + pdesocup + psinder + phogjef_f + vivpar_des +
                           pro_ocup_c+ vph_pisoti + vph_s_elec + vph_aguafv + vph_nodren +
                           vph_inter + amenzas + fraude + robo_objetos +
                           robo_objetos_vehiculo +
                           robo_transeunte + robo_accesorios_autos +
                           robo_negocio_sin_violencia_autoservicio  +
                           robo_negocio_sin_violencia + narcomenudeo +
                           robo_casa_sin_violencia + postes_wifi,
                         robos_entrena)
```



```{r}
modelo_penalizado_2 <- linear_reg(mixture = 0, penalty = .6158482) %>%
  set_args(lambda.min_ratio = 1e-18) %>%
  set_engine("glmnet")  

flujo_robos_2 <- workflow() %>% 
  add_recipe(robos_receta_2) %>% 
  add_model(modelo_penalizado_2)
```


```{r}
ajuste <- fit(flujo_robos_2, robos_entrena)
```


```{r}
metricas <- metric_set(mape, mae, rmse, rsq)
```

```{r}
robos_prueba_normal <- testing(robos_split) 
```


```{r}
metricas(robos_prueba_normal %>% bind_cols(predict(ajuste, robos_prueba_normal)), 
     truth = robo_vehículos, estimate = .pred) 
  #gt() %>% fmt_number(.estimate, decimals = 2)
```

```{r}
robos_prueba_normal %>% bind_cols(predict(ajuste, robos_prueba_normal)) %>%
  ggplot(aes(x = .pred, y = robo_vehículos)) + geom_abline() + 
    geom_point(colour = "red") + coord_obs_pred()
```
```{r}
ajuste %>% pull_workflow_fit() %>% broom::tidy() %>% 
  mutate(across(where(is.numeric), round, 3)) %>%
  select(term, estimate) %>% 
  gt()
```


```{r}
regresion = lm(robo_vehículos ~
                 pop_15_24 + p15ym_an + p15a24a + graproes + pea +
                 pocupada + pdesocup + psinder + phogjef_f + vivpar_des +
                 pro_ocup_c + vph_pisoti + vph_s_elec + vph_aguafv + vph_nodren +
                 vph_inter + amenzas + fraude + robo_objetos +
                 robo_objetos_vehiculo +
                 robo_transeunte + robo_accesorios_autos +
                 robo_negocio_sin_violencia_autoservicio  +
                 robo_negocio_sin_violencia + narcomenudeo +
                 robo_casa_sin_violencia + postes_wifi,
               robos_entrena) #Create the linear regression

summary(regresion) #Review the results
```
### IMPORTANCIA

```{r}
rf <- ranger(robo_vehículos ~
               pop_15_24 + p15ym_an + p15a24a + graproes + pea +
               pocupada + pdesocup + psinder + phogjef_f + vivpar_des +
               pro_ocup_c + vph_pisoti + vph_s_elec + vph_aguafv + vph_nodren +
               vph_inter + amenzas + fraude + robo_objetos +
               robo_objetos_vehiculo +
               robo_transeunte + robo_accesorios_autos +
               robo_negocio_sin_violencia_autoservicio  +
               robo_negocio_sin_violencia + narcomenudeo +
               robo_casa_sin_violencia + postes_wifi,
    data = robos_entrena, importance = "permutation")
```

```{r}
importancia <- importance(rf)
importancia %>% as.data.frame(importancia) %>% rownames_to_column("variable") %>% 
  arrange(desc(.))
```

Modelos con dummies y con bandas
https://www.elfinanciero.com.mx/nacional/40-bandas-se-disputan-la-cdmx/
```{r}
unique(ageb_censo_delitos_wifi$nom_mun)
```
```{r}
glimpse(ageb_censo_delitos_wifi)
```

Cambiamos de doble to character

```{r}
ageb_censo_delitos_wifi$union_tepito <- as.character(ageb_censo_delitos_wifi$union_tepito)
ageb_censo_delitos_wifi$cjng <- as.character(ageb_censo_delitos_wifi$cjng)
ageb_censo_delitos_wifi$cartel_de_tlahuac <- as.character(ageb_censo_delitos_wifi$ cartel_de_tlahuac)
ageb_censo_delitos_wifi$lenin_canchola <- as.character(ageb_censo_delitos_wifi$ lenin_canchola)
ageb_censo_delitos_wifi$anti_union_tepito <- as.character(ageb_censo_delitos_wifi$ anti_union_tepito)
ageb_censo_delitos_wifi$rodolfos <- as.character(ageb_censo_delitos_wifi$rodolfos)
```


Bandas

```{r}

robos_receta_3 <- recipe(robo_vehículos ~
                           pop_15_24 + p15ym_an + p15a24a + graproes + pea +
                           pocupada + pdesocup + psinder + phogjef_f + vivpar_des +
                           pro_ocup_c + vph_pisoti + vph_s_elec + vph_aguafv + vph_nodren +
                           vph_inter + amenzas + fraude + robo_objetos +
                           robo_objetos_vehiculo +
                           robo_transeunte + robo_accesorios_autos +
                           robo_negocio_sin_violencia_autoservicio  +
                           robo_negocio_sin_violencia + narcomenudeo +
                           robo_casa_sin_violencia + postes_wifi +
                           union_tepito + cjng + cartel_de_tlahuac +
                           lenin_canchola + anti_union_tepito + rodolfos,
                         robos_entrena)

```

