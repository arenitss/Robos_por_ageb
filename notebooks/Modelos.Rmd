---
title: "EDA. Incidencia Delictiva por AGEB"
author: "A_NAYELLI XXX, R_URIEL ABRAHAM XXX, ZC_JOSE LUIS R. 183347"
date: "06/11/2021"
output: html_document
---

```{r}
knitr::opts_chunk$set(echo = FALSE)


## ID_F0 --> This function aim to install and load libraries required.
rm(list = ls())

instalar <- function(paquete) {
  if (!require(paquete,character.only = TRUE, quietly = TRUE,
               warn.conflicts = FALSE)) {
    install.packages(as.character(paquete), dependecies = TRUE,
                     repos = "http://cran.us.r-project.org")
    library(paquete, character.only = TRUE, quietly = TRUE,
            warn.conflicts = FALSE)
  }
}
    
## Defining required libraries to install and load:
## Use this vector to indicate libraries to load.
paquetes <- c("tensorflow", "keras", "tidyverse",
              "tidymodels", "glmnet", "kknn","gt","ranger")

#paquetes <- c('readr', 'tidyr', 'tibble', 'dplyr', 'magrittr', 'lubridate',
#              'stringr','ggplot2', 'forcats', "gridExtra", 'ggthemes',
#              'GGally','mice','VIM')

lapply(paquetes, instalar)

## Load piping files and review of working libraries
#source("../src/etl/metadata.R"  , encoding = 'UTF-8')
source("../src/utils/utils.R", encoding = 'UTF-8')
#source("../src/etl/00-load.R", encoding = 'UTF-8')
#source("../src/etl/01-prepare.R", encoding = 'UTF-8')
#ource("../src/etl/02-clean.R", encoding = 'UTF-8')
#source("../src/etl/03-eda.R", encoding = 'UTF-8')
#source("../src/etl/ggbiplot.R",   encoding = 'UTF-8')


```

```{r}
library(tensorflow)
library(keras)
library(tidyverse) 
library(tidymodels) 
library(glmnet)
library(kknn)
library(dplyr)
library(gt)
```
Descargamos base de datos
```{r}
ageb_censo_delitos_wifi <- read_csv("../data/ageb_censo_delitos_wifi.csv")

```

### LIMPIEZA
```{r}
glimpse(ageb_censo_delitos_wifi)
```
Reemplazamos con 0 los nas de las columnas de delitos, porque na significa que no hubo delitos en esa ageb
```{r}
for (i in 54:65){
  ageb_censo_delitos_wifi[which(is.na(ageb_censo_delitos_wifi[,i])),i] = 0
}
```

Creamos la variable de poblacion que entre 15 y 24 años que no asiste a la escuela que faltaba
```{r}
ageb_censo_delitos_wifi<- ageb_censo_delitos_wifi %>%
  mutate(P15A24A = P15A17A + P18A24A)
```


Quitamos la primera columna que es el indice
```{r}
ageb_censo_delitos_wifi<- ageb_censo_delitos_wifi[-1]
```

Pasamos Robo de vehículos al inicio de la base
```{r}
ageb_censo_delitos_wifi<-ageb_censo_delitos_wifi %>% 
  relocate(Robo_Vehículos)

```


Imputamos con la mediana los nas del resto de las columnas

```{r}
#columnas que se desea imputar valores centrales
col_valor_central <- c(10:53,65)
#imputacion por valor central
ageb_censo_delitos_wifi <- imputar_valor_central(data.frame(ageb_censo_delitos_wifi), col_valor_central)

```

```{r}
glimpse(ageb_censo_delitos_wifi)
```

```{r}
summary(ageb_censo_delitos_wifi)
```
Estandarizamos columnas
```{r}

for (i in 10:65){
  ageb_censo_delitos_wifi[,i] <- (ageb_censo_delitos_wifi[,i] - mean(ageb_censo_delitos_wifi[,i])) / sd(ageb_censo_delitos_wifi[,i])
}
```


```{r}
ageb_censo_delitos_wifi$Robo_Vehículos <- (ageb_censo_delitos_wifi$Robo_Vehículos - mean(ageb_censo_delitos_wifi$Robo_Vehículos)) / sd(ageb_censo_delitos_wifi$Robo_Vehículos)
```


```{r}
summary(ageb_censo_delitos_wifi)
```

### Modelos con dummies y con bandas
https://www.elfinanciero.com.mx/nacional/40-bandas-se-disputan-la-cdmx/
```{r}
unique(ageb_censo_delitos_wifi$NOM_MUN)
```

Bandas
```{r}
ageb_censo_delitos_wifi<-ageb_censo_delitos_wifi %>% mutate(union_tepito = ifelse(NOM_MUN == "µlvaro Obreg¢n"|
                                                      NOM_MUN == "Azcapotzalco"|
                                                      NOM_MUN == "Benito Ju rez"|
                                                      NOM_MUN == "Coyoac n"|
                                                      NOM_MUN == "Cuauht\u0082moc"|
                                                      NOM_MUN == "Gustavo A. Madero"|
                                                      NOM_MUN == "Iztacalco"|
                                                      NOM_MUN == "La Magdalena Contreras"|
                                                      NOM_MUN == "Miguel Hidalgo"|
                                                      NOM_MUN == "Tlalpan"|
                                                      NOM_MUN == "Venustiano Carranza", 1,0)
                                                        )
```

```{r}
ageb_censo_delitos_wifi<-ageb_censo_delitos_wifi %>% mutate(cjng = ifelse(NOM_MUN == "µlvaro Obreg¢n"|
                                                      NOM_MUN == "µlvaro Obreg¢n"|
                                                      NOM_MUN == "Benito Ju rez"|
                                                      NOM_MUN == "Cuajimalpa de Morelos"|
                                                      NOM_MUN == "Cuauht\u0082moc"|
                                                      NOM_MUN == "Gustavo A. Madero"|
                                                      NOM_MUN == "Iztapalapa"|
                                                      NOM_MUN == "Tlalpan", 1,0)
                                                        )

```


```{r}
ageb_censo_delitos_wifi<-ageb_censo_delitos_wifi %>% mutate(cartel_de_tlahuac = ifelse(NOM_MUN == "µlvaro Obreg¢n"|
                                                      NOM_MUN == "Tl huac"|
                                                      NOM_MUN == "Iztapalapa"|
                                                      NOM_MUN == "Milpa Alta"|
                                                      NOM_MUN == "Tlalpan"|
                                                      NOM_MUN == "Xochimilco", 1,0)
                                                        )
```

```{r}
ageb_censo_delitos_wifi<-ageb_censo_delitos_wifi %>% mutate(lenin_canchola = ifelse(NOM_MUN == "µlvaro Obreg¢n"|
                                                      NOM_MUN == "µlvaro Obreg¢n"|
                                                      NOM_MUN == "Benito Ju rez"|
                                                      NOM_MUN == "La Magdalena Contreras"|
                                                      NOM_MUN == "Miguel Hidalgo"|
                                                      NOM_MUN == "Tlalpan", 1,0)
                                                        )

```

```{r}
ageb_censo_delitos_wifi<-ageb_censo_delitos_wifi %>% mutate(anti_union_tepito = ifelse(NOM_MUN == "µlvaro Obreg¢n"|
                                                      NOM_MUN == "Azcapotzalco"|
                                                      NOM_MUN == "Cuauht\u0082moc"|
                                                      NOM_MUN == "Iztacalco"|
                                                      NOM_MUN == "Venustiano Carranza", 1,0))
                                                       


```

```{r}
ageb_censo_delitos_wifi<-ageb_censo_delitos_wifi %>% mutate(rodolfos = ifelse(NOM_MUN == "µlvaro Obreg¢n"|
                                                      NOM_MUN == "Coyoac n"|
                                                      NOM_MUN == "Iztacalco"|
                                                      NOM_MUN == "Milpa Alta"|
                                                      NOM_MUN == "Tl huac"|
                                                      NOM_MUN == "Xochimilco", 1,0)
                                                        )


```



## EDA
Análisis bivariado
```{r}
many_scatter_plots <- ManyPlots(df = dplyr::select_if(ageb_censo_delitos_wifi, is.numeric),tipo_grafica = ScatterPlot)
many_scatter_plots

```


```{r}
many_loess_plots <- ManyPlots(df = dplyr::select_if(ageb_censo_delitos_wifi,
is.numeric),tipo_grafica = LoessPlot)
many_loess_plots
```

## MODELO


```{r}
set.seed(84351)
robos_split <- initial_split(ageb_censo_delitos_wifi, prop = 0.75)
robos_entrena <- training(robos_split)
robos_prueba <- testing(robos_split)
```


```{r}
robos_receta <- recipe(Robo_Vehículos ~ pop_15_24 + P15YM_AN+ P15A24A +GRAPROES+
 PEA + POCUPADA + PDESOCUP+ PSINDER+ PHOGJEF_F + VIVPAR_DES +
 PRO_OCUP_C+ VPH_PISOTI + VPH_S_ELEC + VPH_AGUAFV + VPH_NODREN + VPH_INTER + Amenzas +Fraude + Robo_Objetos + Robo_Objetos_Vehiculo + Robo_Transeunte + Robo_Accesorios_Autos+ Robo_Negocio_Sin_Violencia_Autoservicio  +
Robo_Negocio_Sin_Violencia + Narcomenudeo + Robo_Casa_Sin_Violencia +
Postes_Wifi, robos_entrena)
```

```{r}
modelo_penalizado <- linear_reg(mixture = tune(), penalty = tune()) %>%
  set_args(lambda.min_ratio = 1e-18) %>%
  set_engine("glmnet")  
flujo_robos <- workflow() %>% 
  add_recipe(robos_receta) %>% 
  add_model(modelo_penalizado)
```

```{r}
val_split <- manual_rset(robos_split %>% list(), "validación")
# hacemos un grid de valores de mezcla y penalización
params <- parameters(penalty(range = c(-5, 2), trans = log10_trans()),
                            mixture(range = c(0, 1)))
grid <- grid_regular(params, levels = c(penalty = 20, mixture = 5))
grid
```

```{r}
mis_metricas <- metric_set(rmse)
eval_tbl <- tune_grid(flujo_robos,
                      resamples = val_split,
                      grid = grid,
                      metrics = mis_metricas) 
```

```{r}
ajustes_tbl <- eval_tbl %>%
  unnest(cols = c(.metrics)) %>% 
  select(id, mixture, penalty, .metric, .estimate)
ajustes_tbl
```


```{r}
ggplot(ajustes_tbl, aes(x = penalty, y = .estimate, colour = mixture, group = mixture)) +
  geom_point() + geom_line() + scale_x_log10()
```

```{r}
mejor_modelo <- select_best(eval_tbl)
mejor_modelo
```

```{r}
modelo_final <- finalize_workflow(flujo_robos, mejor_modelo) %>%
  fit(robos_entrena)

```

```{r}
robos_receta_2 <- recipe(Robo_Vehículos ~ pop_15_24 + P15YM_AN+ P15A24A +GRAPROES+
 PEA + POCUPADA + PDESOCUP+ PSINDER+ PHOGJEF_F + VIVPAR_DES +
 PRO_OCUP_C+ VPH_PISOTI + VPH_S_ELEC + VPH_AGUAFV + VPH_NODREN + VPH_INTER + Amenzas +Fraude + Robo_Objetos + Robo_Objetos_Vehiculo + Robo_Transeunte + Robo_Accesorios_Autos+ Robo_Negocio_Sin_Violencia_Autoservicio  +
Robo_Negocio_Sin_Violencia + Narcomenudeo + Robo_Casa_Sin_Violencia +
Postes_Wifi, robos_entrena)

```



```{r}
modelo_penalizado_2 <- linear_reg(mixture = 0, penalty = .6158482) %>%
  set_args(lambda.min_ratio = 1e-18) %>%
  set_engine("glmnet")  
flujo_robos_2 <- workflow() %>% 
  add_recipe(robos_receta_2) %>% 
  add_model(modelo_penalizado_2)
```


```{r}
ajuste <- fit(flujo_robos_2, robos_entrena)
```


```{r}
metricas <- metric_set(mape, mae, rmse, rsq)
```

```{r}
robos_prueba_normal <- testing(robos_split) 
```


```{r}
metricas(robos_prueba_normal %>% bind_cols(predict(ajuste, robos_prueba_normal)), 
     truth = Robo_Vehículos, estimate = .pred) 
  #gt() %>% fmt_number(.estimate, decimals = 2)
```

```{r}
robos_prueba_normal %>% bind_cols(predict(ajuste, robos_prueba_normal)) %>%
  ggplot(aes(x = .pred, y = Robo_Vehículos)) + geom_abline() + 
    geom_point(colour = "red") + coord_obs_pred()
```
```{r}
ajuste %>% pull_workflow_fit() %>% broom::tidy() %>% 
  mutate(across(where(is.numeric), round, 3)) %>%
  select(term, estimate) %>% 
  gt()
```
```{r}
regresion = lm(Robo_Vehículos ~ pop_15_24 + P15YM_AN+ P15A24A +GRAPROES+
 PEA + POCUPADA + PDESOCUP+ PSINDER+ PHOGJEF_F + VIVPAR_DES +
 PRO_OCUP_C+ VPH_PISOTI + VPH_S_ELEC + VPH_AGUAFV + VPH_NODREN + VPH_INTER + Amenzas +Fraude + Robo_Objetos + Robo_Objetos_Vehiculo + Robo_Transeunte + Robo_Accesorios_Autos+ Robo_Negocio_Sin_Violencia_Autoservicio  +
Robo_Negocio_Sin_Violencia + Narcomenudeo + Robo_Casa_Sin_Violencia +
Postes_Wifi, robos_entrena) #Create the linear regression
summary(regresion) #Review the results

```
### IMPORTANCIA

```{r}

```
```{r}

```


```{r}
rf <- ranger(Robo_Vehículos ~ pop_15_24 + P15YM_AN + P15A24A + 
    GRAPROES + PEA + POCUPADA + PDESOCUP + PSINDER + PHOGJEF_F + 
    VIVPAR_DES + PRO_OCUP_C + VPH_PISOTI + VPH_S_ELEC + VPH_AGUAFV + 
    VPH_NODREN + VPH_INTER + Amenzas + Fraude + Robo_Objetos + 
    Robo_Objetos_Vehiculo + Robo_Transeunte + Robo_Accesorios_Autos + 
    Robo_Negocio_Sin_Violencia_Autoservicio + Robo_Negocio_Sin_Violencia + 
    Narcomenudeo + Robo_Casa_Sin_Violencia + Postes_Wifi, data = robos_entrena, importance = "permutation")
```

```{r}
importance(rf)->importancia
sort(importancia,decreasing = TRUE)
```

Modelos con dummies y con bandas
https://www.elfinanciero.com.mx/nacional/40-bandas-se-disputan-la-cdmx/
```{r}
unique(ageb_censo_delitos_wifi$NOM_MUN)
```
```{r}
glimpse(ageb_censo_delitos_wifi)
```

Cambiamos de doble to character
```{r}
ageb_censo_delitos_wifi$union_tepito <- as.character(ageb_censo_delitos_wifi$union_tepito)

ageb_censo_delitos_wifi$cjng <- as.character(ageb_censo_delitos_wifi$cjng)

ageb_censo_delitos_wifi$ cartel_de_tlahuac <- as.character(ageb_censo_delitos_wifi$ cartel_de_tlahuac)

ageb_censo_delitos_wifi$ lenin_canchola <- as.character(ageb_censo_delitos_wifi$ lenin_canchola)

ageb_censo_delitos_wifi$ anti_union_tepito <- as.character(ageb_censo_delitos_wifi$ anti_union_tepito)

ageb_censo_delitos_wifi$rodolfos <- as.character(ageb_censo_delitos_wifi$rodolfos)



```


Bandas

```{r}
robos_receta_3 <- recipe(Robo_Vehículos ~ pop_15_24 + P15YM_AN+ P15A24A +GRAPROES+
 PEA + POCUPADA + PDESOCUP+ PSINDER+ PHOGJEF_F + VIVPAR_DES +
 PRO_OCUP_C+ VPH_PISOTI + VPH_S_ELEC + VPH_AGUAFV + VPH_NODREN + VPH_INTER + Amenzas +Fraude + Robo_Objetos + Robo_Objetos_Vehiculo + Robo_Transeunte + Robo_Accesorios_Autos+ Robo_Negocio_Sin_Violencia_Autoservicio  +
Robo_Negocio_Sin_Violencia + Narcomenudeo + Robo_Casa_Sin_Violencia +
Postes_Wifi+union_tepito+cjng+cartel_de_tlahuac+lenin_canchola+anti_union_tepito+rodolfos , robos_entrena)
```

